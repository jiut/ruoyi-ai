# 设计师性别字段修复说明

## 问题描述

在测试 `/designer/user/register/designer` 接口时发现，数据库中 `gender` 字段存在数据不一致的问题：

1. **数据库设计**：`gender CHAR(1)` 字段应该存储数字代码（0男 1女 2未知）
2. **实际数据**：数据库中同时存在数字（0,1）和中文（女）两种格式
3. **API文档**：之前的 Schema 注解使用中文格式，与数据库设计不符

## 解决方案

### 1. 统一数据格式

**数据库存储格式**（标准）：
- `0` = 男
- `1` = 女  
- `2` = 未知

### 2. 修复代码实现

#### 2.1 创建性别枚举类

**文件**：`ruoyi-modules/ruoyi-designer/src/main/java/org/ruoyi/designer/domain/enums/GenderEnum.java`

```java
@Getter
@AllArgsConstructor
public enum GenderEnum {
    MALE("0", "男"),
    FEMALE("1", "女"),
    UNKNOWN("2", "未知");

    private final String code;  // 数据库存储值
    private final String name;  // 显示名称
    
    // 提供转换方法
    public static String convertNameToCode(String name);
    public static String convertCodeToName(String code);
}
```

#### 2.2 修正 Designer 实体类

**修改**：`gender` 字段的 `@Schema` 注解

```java
// 修改前
@Schema(description = "性别", example = "男", allowableValues = {"男", "女", "未知"})

// 修改后  
@Schema(description = "性别", example = "0", allowableValues = {"0", "1", "2"})
```

#### 2.3 增强服务层转换逻辑

在 `DesignerServiceImpl` 中添加 `convertGenderField()` 方法：

```java
private void convertGenderField(Designer designer) {
    if (StringUtils.isNotBlank(designer.getGender())) {
        String gender = designer.getGender();
        // 如果是中文，转换为数字代码
        if ("男".equals(gender) || "女".equals(gender) || "未知".equals(gender)) {
            designer.setGender(GenderEnum.convertNameToCode(gender));
        }
        // 如果是其他值，设置为未知
        else if (!"0".equals(gender) && !"1".equals(gender) && !"2".equals(gender)) {
            designer.setGender(GenderEnum.UNKNOWN.getCode());
        }
    }
}
```

### 3. 数据库修复脚本

**文件**：`script/sql/fix_gender_data.sql`

```sql
-- 修复现有数据
UPDATE des_designer 
SET gender = CASE 
    WHEN gender = '男' THEN '0'
    WHEN gender = '女' THEN '1'
    WHEN gender = '0' THEN '0'
    WHEN gender = '1' THEN '1'
    WHEN gender = '2' THEN '2'
    ELSE '2'  -- 其他值设置为未知
END
WHERE gender IS NOT NULL;

-- 处理NULL值
UPDATE des_designer 
SET gender = '2' 
WHERE gender IS NULL;
```

## 使用说明

### 1. API 请求格式

#### 正确的请求示例

```json
{
    "designerName": "张三",
    "avatar": "https://avatars.githubusercontent.com/u/27265998",
    "gender": "0",
    "birthDate": "1995-06-15",
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "description": "专业UI设计师，擅长原型设计和视觉设计",
    "profession": "UI_DESIGNER",
    "skillTags": "[\"PROTOTYPE_DESIGN\", \"VISUAL_DESIGN\"]",
    "workYears": 3,
    "portfolioUrl": "https://portfolio.example.com",
    "socialLinks": "{\"github\":\"https://github.com/zhangsan\"}"
}
```

#### 兼容性支持

系统现在支持两种格式的输入：

**数字格式**（推荐）：
```json
{
    "gender": "0"  // 男
}
```

**中文格式**（兼容）：
```json
{
    "gender": "男"  // 会自动转换为 "0"
}
```

### 2. 性别字段值对照表

| 数据库存储值 | 显示名称 | 说明 |
|-------------|----------|------|
| `0` | 男 | 男性 |
| `1` | 女 | 女性 |
| `2` | 未知 | 未知或不愿透露 |

### 3. 错误处理

如果传入无效的性别值，系统会自动设置为 `2`（未知）：

```java
// 无效输入示例
"gender": "其他"     // 转换为 "2"
"gender": "male"    // 转换为 "2"  
"gender": ""        // 转换为 "2"
```

## 部署步骤

### 1. 执行数据库修复脚本

```bash
# 连接到数据库
mysql -u username -p database_name

# 执行修复脚本
source script/sql/fix_gender_data.sql;
```

### 2. 重新编译项目

```bash
mvn clean compile -DskipTests -pl ruoyi-modules/ruoyi-designer
```

### 3. 重启应用程序

重启后新的转换逻辑生效。

## 验证测试

### 1. 验证数据库修复结果

```sql
-- 检查性别字段分布
SELECT 
    gender,
    COUNT(*) as count,
    CASE 
        WHEN gender = '0' THEN '男'
        WHEN gender = '1' THEN '女'
        WHEN gender = '2' THEN '未知'
        ELSE '异常数据'
    END as gender_name
FROM des_designer 
GROUP BY gender;
```

### 2. 测试API接口

#### 测试数字格式输入

```bash
POST /designer/user/register/designer
{
    "designerName": "测试用户1",
    "gender": "0",
    "phone": "13800138001",
    "email": "test1@example.com",
    "profession": "UI_DESIGNER"
}
```

#### 测试中文格式输入（兼容性）

```bash
POST /designer/user/register/designer
{
    "designerName": "测试用户2", 
    "gender": "女",
    "phone": "13800138002",
    "email": "test2@example.com",
    "profession": "UI_DESIGNER"
}
```

#### 验证数据库存储

```sql
SELECT designer_name, gender FROM des_designer 
WHERE designer_name IN ('测试用户1', '测试用户2');
```

预期结果：两条记录的 `gender` 字段都应该是数字格式（"0" 或 "1"）。

## 注意事项

1. **向后兼容**：修复后的系统仍然支持中文格式输入，会自动转换
2. **数据一致性**：所有新增和更新操作都会确保数据库中存储数字格式
3. **API文档**：Swagger 文档现在显示正确的数字格式示例
4. **前端适配**：前端可以继续使用中文格式，后端会自动处理转换

## 扩展功能

### 1. 性别显示转换

如果需要在查询时返回中文显示，可以在 VO 类中添加转换：

```java
public class DesignerVo {
    private String gender;
    
    public String getGenderName() {
        return GenderEnum.convertCodeToName(this.gender);
    }
}
```

### 2. 前端枚举定义

前端可以定义对应的枚举：

```javascript
const GenderEnum = {
    MALE: { code: '0', name: '男' },
    FEMALE: { code: '1', name: '女' },
    UNKNOWN: { code: '2', name: '未知' }
};
```

这样确保了前后端数据格式的一致性和可维护性。 