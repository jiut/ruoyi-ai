# 企业管理接口修复说明

## 问题描述

在测试 `/designer/enterprise` PUT 接口时遇到 500 错误，主要原因是：

1. **操作日志转换器缺失**：MapStruct 的 `OperLogEvent` 到 `SysOperLogBo` 转换器未正确生成
2. **企业更新逻辑缺陷**：PUT 请求没有提供 `enterpriseId`，且 `@JsonIgnore` 导致无法通过 JSON 传递

## 解决方案

### 1. 修复操作日志转换器问题

**问题根源**：编译时生成的 MapStruct 转换器没有被应用程序正确加载。

**解决步骤**：
```bash
# 重新编译整个项目
mvn clean compile -DskipTests

# 重启应用程序
```

转换器已正确生成在：
```
ruoyi-modules-api/ruoyi-system-api/target/generated-sources/annotations/org/ruoyi/common/log/event/OperLogEventToSysOperLogBoMapperImpl.java
```

### 2. 修复企业更新逻辑

**修改文件**：`ruoyi-modules/ruoyi-designer/src/main/java/org/ruoyi/designer/service/impl/EnterpriseServiceImpl.java`

**关键修改**：

```java
@Override
public Boolean updateEnterprise(Enterprise enterprise) {
    // 如果没有提供企业ID，则根据当前用户ID查找企业
    if (enterprise.getEnterpriseId() == null) {
        Long userId = LoginHelper.getUserId();
        Enterprise existingEnterprise = selectEnterpriseByUserId(userId);
        if (existingEnterprise == null) {
            throw new RuntimeException("当前用户未绑定企业信息");
        }
        enterprise.setEnterpriseId(existingEnterprise.getEnterpriseId());
        enterprise.setUserId(userId);
    }
    return updateById(enterprise);
}

@Override
public Boolean insertEnterprise(Enterprise enterprise) {
    // 设置当前用户ID
    enterprise.setUserId(LoginHelper.getUserId());
    return save(enterprise);
}
```

## 接口使用说明

### 1. 企业注册（POST）

**接口**：`POST /designer/user/register/enterprise`

**请求体**：
```json
{
    "enterpriseName": "创新科技有限公司",
    "description": "专注于互联网产品设计与开发的创新型企业",
    "address": "北京市朝阳区",
    "phone": "010-12345678",
    "email": "contact@company.com",
    "website": "https://www.company.com",
    "scale": "100-500人",
    "industry": "互联网",
    "logo": "https://www.company.com/logo.png"
}
```

**说明**：
- 自动绑定到当前登录用户
- 不需要提供 `enterpriseId` 和 `userId`
- 系统自动设置 `status` 为 "0"（正常）

### 2. 企业信息更新（PUT）

**接口**：`PUT /designer/enterprise`

**请求体**：
```json
{
    "enterpriseName": "创新科技有限公司",
    "description": "专注于互联网产品设计与开发的创新型企业",
    "address": "北京市朝阳区",
    "phone": "010-12345678",
    "email": "contact@company.com",
    "website": "https://www.company.com",
    "scale": "100-500人",
    "industry": "互联网",
    "logo": "https://www.company.com/logo.png",
    "status": "0"
}
```

**说明**：
- **不需要提供** `enterpriseId` 和 `userId`
- 系统自动根据当前登录用户查找对应的企业进行更新
- 如果当前用户未绑定企业，会抛出异常

### 3. 查询企业信息（GET）

**接口**：`GET /designer/user/enterprise/profile`

**说明**：获取当前用户绑定的企业信息

## 测试步骤

### 1. 用户登录
```bash
POST /auth/login
{
    "username": "test",
    "password": "admin123",
    "captcha": "1234",
    "uuid": "test-uuid"
}
```

### 2. 注册企业身份
```bash
POST /designer/user/register/enterprise
{
    "enterpriseName": "创新科技有限公司",
    "description": "专注于互联网产品设计与开发",
    "industry": "互联网",
    "scale": "100-500人",
    "address": "北京市朝阳区",
    "email": "hr@innovation.com",
    "phone": "010-12345678",
    "website": "https://www.innovation.com"
}
```

### 3. 更新企业信息
```bash
PUT /designer/enterprise
{
    "enterpriseName": "创新科技",
    "description": "专注于互联网产品设计与开发的创新型企业",
    "address": "北京市朝阳区",
    "phone": "010-12345678",
    "email": "contact@company.com",
    "website": "https://www.company.com",
    "scale": "100-500人",
    "industry": "互联网",
    "logo": "https://www.company.com/logo.png",
    "status": "0"
}
```

## 权限说明

### 企业管理权限矩阵

| 操作 | 系统管理员 | 企业管理员 | 设计师 | 院校管理员 |
|------|------------|------------|---------|------------|
| 查看所有企业 | ✓ | ✗ | ✗ | ✗ |
| 查看自己企业 | ✓ | ✓ | ✗ | ✗ |
| 创建企业 | ✓ | ✓ | ✗ | ✗ |
| 更新企业信息 | ✓ | ✓(自己) | ✗ | ✗ |
| 删除企业 | ✓ | ✗ | ✗ | ✗ |

### 数据隔离机制

1. **用户绑定**：每个企业通过 `user_id` 字段绑定到特定用户
2. **自动权限控制**：更新操作自动限制为当前用户绑定的企业
3. **管理员特权**：系统管理员可以操作所有企业数据

## 注意事项

1. **重启应用**：修复后需要重启应用程序以加载新的转换器
2. **用户绑定**：企业更新操作依赖用户绑定关系，确保用户已注册企业身份
3. **JSON 字段**：`enterpriseId` 和 `userId` 被标记为 `@JsonIgnore`，不应在请求中包含
4. **状态管理**：企业状态 "0" 表示正常，"1" 表示停用

## 错误处理

### 常见错误及解决方案

1. **"当前用户未绑定企业信息"**
   - 原因：用户尚未注册企业身份
   - 解决：先调用企业注册接口

2. **"操作失败"（500错误）**
   - 原因：转换器未加载或业务逻辑错误
   - 解决：重启应用程序，检查日志

3. **权限不足**
   - 原因：用户没有企业管理权限
   - 解决：确保用户具有 `designer:enterprise:edit` 权限

## 后续优化建议

1. **接口设计优化**：考虑将企业ID作为路径参数，如 `PUT /designer/enterprise/{enterpriseId}`
2. **错误信息优化**：提供更详细的错误信息和错误码
3. **批量操作**：支持批量更新企业信息
4. **审计日志**：增强操作日志记录，包含更多业务上下文 