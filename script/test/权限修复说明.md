# 岗位招聘权限修复说明

## 🎯 问题描述

用户反馈：解绑企业身份后，仍然可以使用 `POST /designer/job` 接口发布岗位，这是一个严重的权限控制漏洞。

### 原始问题
- 用户可以在解绑企业身份后继续发布岗位
- 没有验证用户的企业身份状态
- 存在数据安全隐患

## 🔧 修复方案

### 1. 添加企业身份验证

在 `JobPostingController` 中的关键方法添加了企业身份验证：

#### 发布岗位接口 (`POST /designer/job`)
```java
@PostMapping
public R<Void> add(@Validated @RequestBody JobPosting jobPosting) {
    // 验证当前用户是否为企业用户
    if (!permissionUtils.isEnterprise()) {
        return R.fail("只有企业用户才能发布岗位");
    }
    
    // 获取当前用户绑定的企业ID
    Long enterpriseId = permissionUtils.getCurrentEnterpriseId();
    if (enterpriseId == null) {
        return R.fail("未找到企业身份，请先注册企业账户");
    }
    
    // 设置企业ID到岗位信息中
    jobPosting.setEnterpriseId(enterpriseId);
    
    return toAjax(jobPostingService.insertJobPosting(jobPosting));
}
```

#### 修改岗位接口 (`PUT /designer/job`)
```java
@PutMapping
public R<Void> edit(@Validated @RequestBody JobPosting jobPosting) {
    // 验证当前用户是否为企业用户
    if (!permissionUtils.isEnterprise()) {
        return R.fail("只有企业用户才能修改岗位");
    }
    
    // 验证岗位归属权限
    JobPosting existingJob = jobPostingService.selectJobPostingById(jobPosting.getJobId());
    if (existingJob == null) {
        return R.fail("岗位不存在");
    }
    
    if (!permissionUtils.hasEnterprisePermission(existingJob.getEnterpriseId())) {
        return R.fail("无权限修改此岗位");
    }
    
    return toAjax(jobPostingService.updateJobPosting(jobPosting));
}
```

#### 删除岗位接口 (`DELETE /designer/job/{jobIds}`)
```java
@DeleteMapping("/{jobIds}")
public R<Void> remove(@PathVariable Long[] jobIds) {
    // 验证当前用户是否为企业用户
    if (!permissionUtils.isEnterprise()) {
        return R.fail("只有企业用户才能删除岗位");
    }
    
    // 验证所有岗位的归属权限
    for (Long jobId : jobIds) {
        JobPosting existingJob = jobPostingService.selectJobPostingById(jobId);
        if (existingJob == null) {
            return R.fail("岗位不存在: " + jobId);
        }
        
        if (!permissionUtils.hasEnterprisePermission(existingJob.getEnterpriseId())) {
            return R.fail("无权限删除岗位: " + jobId);
        }
    }
    
    return toAjax(jobPostingService.deleteJobPostingByIds(Arrays.asList(jobIds)));
}
```

#### 企业岗位查询接口 (`GET /designer/job/enterprise/{enterpriseId}`)
```java
@GetMapping("/enterprise/{enterpriseId}")
public R<List<JobPosting>> getByEnterprise(@PathVariable Long enterpriseId) {
    // 验证权限：只有该企业用户或管理员才能查询企业岗位
    if (!permissionUtils.hasEnterprisePermission(enterpriseId)) {
        return R.fail("无权限查询该企业的岗位信息");
    }
    
    return R.ok(jobPostingService.selectJobPostingByEnterprise(enterpriseId));
}
```

### 2. 权限验证逻辑

#### 使用的权限工具类方法
- `permissionUtils.isEnterprise()` - 检查当前用户是否为企业用户
- `permissionUtils.getCurrentEnterpriseId()` - 获取当前用户绑定的企业ID
- `permissionUtils.hasEnterprisePermission(enterpriseId)` - 检查用户对特定企业的权限

#### 验证层级
1. **身份验证**: 检查用户是否具有企业身份
2. **实体绑定验证**: 确认用户绑定的企业ID有效
3. **数据归属验证**: 确保用户只能操作自己企业的岗位

## ✅ 修复效果

### 现在的行为
1. **解绑企业身份后**：
   - ❌ 无法发布新岗位
   - ❌ 无法修改已发布的岗位
   - ❌ 无法删除已发布的岗位
   - ❌ 无法查询企业岗位列表

2. **企业用户**：
   - ✅ 可以发布岗位（自动设置为当前企业）
   - ✅ 可以修改自己企业的岗位
   - ✅ 可以删除自己企业的岗位
   - ✅ 可以查询自己企业的岗位

3. **超级管理员**：
   - ✅ 可以操作所有企业的岗位
   - ✅ 拥有完整的管理权限

### 错误提示信息
- `"只有企业用户才能发布岗位"`
- `"未找到企业身份，请先注册企业账户"`
- `"无权限修改此岗位"`
- `"无权限删除岗位: {jobId}"`
- `"无权限查询该企业的岗位信息"`

## 🧪 测试验证

### 测试场景
1. **解绑企业身份测试**
   ```bash
   # 1. 用户注册企业身份
   POST /designer/user/register/enterprise
   
   # 2. 发布岗位（应该成功）
   POST /designer/job
   
   # 3. 解绑企业身份
   PUT /designer/user/unbind/enterprise
   
   # 4. 尝试再次发布岗位（应该失败）
   POST /designer/job
   ```
   
   **预期结果**: 第4步返回 `"只有企业用户才能发布岗位"`

2. **跨企业权限测试**
   ```bash
   # 1. 企业A用户尝试修改企业B的岗位
   PUT /designer/job (jobId: 企业B的岗位ID)
   ```
   
   **预期结果**: 返回 `"无权限修改此岗位"`

3. **非企业用户测试**
   ```bash
   # 1. 设计师用户尝试发布岗位
   POST /designer/job
   ```
   
   **预期结果**: 返回 `"只有企业用户才能发布岗位"`

## 📋 安全加固

### 1. 多层权限验证
- Sa-Token权限注解：`@SaCheckPermission("designer:job:add")`
- 企业身份验证：`permissionUtils.isEnterprise()`
- 数据归属验证：`permissionUtils.hasEnterprisePermission(enterpriseId)`

### 2. 自动设置企业ID
- 发布岗位时自动设置为当前用户绑定的企业ID
- 防止用户手动指定其他企业ID

### 3. 实时身份检查
- 每次操作都进行实时的身份状态检查
- 确保解绑后立即生效

## 🔄 向后兼容性

- 修改仅影响权限验证逻辑，不影响数据结构
- 现有的岗位数据和接口响应格式保持不变
- 管理员权限不受影响

## 📝 注意事项

1. **管理员特权**: 超级管理员仍然可以操作所有岗位
2. **错误处理**: 提供明确的错误信息，便于用户理解
3. **性能影响**: 权限检查对接口性能影响极小
4. **日志记录**: 权限验证失败会被记录在操作日志中

## 🎯 下一步建议

1. **添加单元测试**: 为权限验证逻辑编写完整的单元测试
2. **审计日志**: 记录所有权限验证失败的操作
3. **前端适配**: 前端需要根据用户身份状态显示/隐藏操作按钮
4. **批量操作优化**: 对于批量删除等操作，可以考虑事务回滚机制

---

**修复完成时间**: 2025-06-13  
**影响范围**: 岗位招聘相关接口  
**风险等级**: 低（仅加强权限控制） 