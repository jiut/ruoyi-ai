# ä¿®å¤é‡æ–°ç»‘å®šå”¯ä¸€çº¦æŸå†²çªé—®é¢˜

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åœ¨è§£ç»‘è®¾è®¡å¸ˆèº«ä»½åï¼Œå†æ¬¡å°è¯•æ³¨å†Œè®¾è®¡å¸ˆæ—¶é‡åˆ°æ•°æ®åº“å”¯ä¸€çº¦æŸå†²çªé”™è¯¯ï¼š

```
SQLIntegrityConstraintViolationException: Duplicate entry '1933082743395094530-designer' 
for key 'des_user_binding.uk_user_entity'
```

## ğŸ¯ é—®é¢˜æ ¹æœ¬åŸå› 

### æ•°æ®åº“è®¾è®¡
- `des_user_binding` è¡¨æœ‰å”¯ä¸€çº¦æŸ `uk_user_entity`ï¼ŒåŸºäº `(user_id, entity_type)` å­—æ®µ
- è§£ç»‘æ“ä½œä½¿ç”¨"è½¯åˆ é™¤"ï¼šå°† `binding_status` ä» `'1'` æ›´æ–°ä¸º `'0'`ï¼Œä½†è®°å½•ä»ç„¶å­˜åœ¨

### ä¸šåŠ¡é€»è¾‘ç¼ºé™·
1. **ç»‘å®šæ£€æŸ¥é€»è¾‘é—®é¢˜**ï¼š
   ```java
   // åŸé€»è¾‘ï¼šåªæŸ¥è¯¢ binding_status = '1' çš„è®°å½•
   UserBinding existing = getBindingByUserIdAndEntityType(userId, entityType);
   if (existing != null) {
       // æ›´æ–°ç°æœ‰è®°å½•
   } else {
       // åˆ›å»ºæ–°è®°å½• â† è¿™é‡Œæœ‰é—®é¢˜ï¼
   }
   ```

2. **è§£ç»‘åçš„çŠ¶æ€**ï¼š
   - æŸ¥è¯¢ `binding_status = '1'` è¿”å› `null`
   - ç³»ç»Ÿè®¤ä¸ºæ²¡æœ‰ç»‘å®šè®°å½•
   - å°è¯•åˆ›å»ºæ–°è®°å½•æ—¶è¿åå”¯ä¸€çº¦æŸ

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ–°å¢æŸ¥è¯¢æ–¹æ³•

åœ¨ `UserBindingMapper` ä¸­æ·»åŠ æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€è®°å½•çš„æ–¹æ³•ï¼š

```java
/**
 * æ ¹æ®ç”¨æˆ·IDå’Œå®ä½“ç±»å‹æŸ¥è¯¢ç»‘å®šå…³ç³»ï¼ˆåŒ…æ‹¬æ‰€æœ‰çŠ¶æ€ï¼‰
 */
@Select("SELECT * FROM des_user_binding WHERE user_id = #{userId} AND entity_type = #{entityType}")
UserBinding selectByUserIdAndEntityTypeAllStatus(@Param("userId") Long userId, @Param("entityType") String entityType);
```

### 2. ä¿®æ”¹ç»‘å®šé€»è¾‘

æ›´æ–° `UserBindingServiceImpl.bindUserToEntity` æ–¹æ³•ï¼š

```java
@Override
public Boolean bindUserToEntity(Long userId, UserEntityType entityType, Long entityId) {
    // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç»‘å®šå…³ç³»ï¼ˆåŒ…æ‹¬æ‰€æœ‰çŠ¶æ€ï¼‰
    UserBinding existing = userBindingMapper.selectByUserIdAndEntityTypeAllStatus(userId, entityType.getCode());
    if (existing != null) {
        // å¦‚æœå·²å­˜åœ¨è®°å½•ï¼Œæ›´æ–°ç»‘å®šçŠ¶æ€å’Œå®ä½“IDï¼ˆé‡æ–°æ¿€æ´»ç»‘å®šï¼‰
        existing.setEntityId(entityId);
        existing.setBindingStatus("1");
        return updateById(existing);
    }
    
    // åˆ›å»ºæ–°çš„ç»‘å®šå…³ç³»
    UserBinding binding = new UserBinding();
    binding.setUserId(userId);
    binding.setEntityType(entityType.getCode());
    binding.setEntityId(entityId);
    binding.setBindingStatus("1");
    
    return save(binding);
}
```

### 3. ä¼˜åŒ–æ³¨å†Œé€»è¾‘

ä¿®æ”¹æ³¨å†Œæ¥å£ï¼Œæ”¯æŒé‡æ–°æ¿€æ´»å·²è§£ç»‘çš„è®¾è®¡å¸ˆï¼š

```java
@PostMapping("/register/designer")
public R<Void> registerDesigner(@Validated @RequestBody Designer designer) {
    Long userId = LoginHelper.getUserId();
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»‘å®šäº†è®¾è®¡å¸ˆï¼ˆåªæ£€æŸ¥æœ‰æ•ˆç»‘å®šï¼‰
    if (userBindingService.isUserBoundToEntityType(userId, UserEntityType.DESIGNER)) {
        return R.fail("ç”¨æˆ·å·²ç»‘å®šè®¾è®¡å¸ˆèº«ä»½");
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å†å²ç»‘å®šè®°å½•ï¼ˆåŒ…æ‹¬è§£ç»‘çŠ¶æ€ï¼‰
    UserBinding existingBinding = userBindingService.getBindingByUserIdAndEntityTypeAllStatus(userId, UserEntityType.DESIGNER);
    if (existingBinding != null && "0".equals(existingBinding.getBindingStatus())) {
        // å¦‚æœæœ‰è§£ç»‘è®°å½•ï¼Œæ›´æ–°ç°æœ‰è®¾è®¡å¸ˆä¿¡æ¯å¹¶é‡æ–°æ¿€æ´»ç»‘å®š
        Long existingDesignerId = existingBinding.getEntityId();
        Designer existingDesigner = designerService.selectDesignerById(existingDesignerId);
        if (existingDesigner != null) {
            // æ›´æ–°è®¾è®¡å¸ˆä¿¡æ¯
            designer.setDesignerId(existingDesignerId);
            designer.setUserId(userId);
            if (designerService.updateDesigner(designer)) {
                // é‡æ–°æ¿€æ´»ç»‘å®šå…³ç³»
                userBindingService.bindUserToEntity(userId, UserEntityType.DESIGNER, existingDesignerId);
                return R.ok();
            }
        }
    }
    
    // è®¾ç½®ç”¨æˆ·ID
    designer.setUserId(userId);
    
    // ä¿å­˜è®¾è®¡å¸ˆä¿¡æ¯
    if (designerService.insertDesigner(designer)) {
        // åˆ›å»ºç”¨æˆ·ç»‘å®šå…³ç³»
        userBindingService.bindUserToEntity(userId, UserEntityType.DESIGNER, designer.getDesignerId());
        return R.ok();
    }
    
    return R.fail("æ³¨å†Œå¤±è´¥");
}
```

### 4. æ”¹è¿›è§£ç»‘é€»è¾‘

ç¡®ä¿è§£ç»‘æ“ä½œçš„ä¸€è‡´æ€§ï¼š

```java
@Override
public Boolean unbindUserFromEntity(Long userId, UserEntityType entityType) {
    // æŸ¥è¯¢åŒ…æ‹¬æ‰€æœ‰çŠ¶æ€çš„ç»‘å®šè®°å½•
    UserBinding binding = userBindingMapper.selectByUserIdAndEntityTypeAllStatus(userId, entityType.getCode());
    if (binding != null && "1".equals(binding.getBindingStatus())) {
        // åªæœ‰å½“å‰çŠ¶æ€ä¸ºç»‘å®šæ—¶æ‰æ‰§è¡Œè§£ç»‘æ“ä½œ
        binding.setBindingStatus("0");
        return updateById(binding);
    }
    return true;
}
```

## ğŸ”„ ä¿®å¤åçš„å®Œæ•´æµç¨‹

### åœºæ™¯1ï¼šé¦–æ¬¡æ³¨å†Œè®¾è®¡å¸ˆ
1. ç”¨æˆ·è°ƒç”¨ `/designer/user/register/designer`
2. æ£€æŸ¥æ— ä»»ä½•ç»‘å®šè®°å½•
3. åˆ›å»ºæ–°çš„è®¾è®¡å¸ˆè®°å½•å’Œç»‘å®šå…³ç³»
4. æˆåŠŸè¿”å›

### åœºæ™¯2ï¼šè§£ç»‘åé‡æ–°æ³¨å†Œ
1. ç”¨æˆ·ä¹‹å‰å·²è§£ç»‘è®¾è®¡å¸ˆèº«ä»½ï¼ˆ`binding_status = '0'`ï¼‰
2. ç”¨æˆ·è°ƒç”¨ `/designer/user/register/designer`
3. æ£€æŸ¥å‘ç°æœ‰è§£ç»‘çŠ¶æ€çš„å†å²è®°å½•
4. æ›´æ–°ç°æœ‰è®¾è®¡å¸ˆä¿¡æ¯
5. é‡æ–°æ¿€æ´»ç»‘å®šå…³ç³»ï¼ˆ`binding_status = '1'`ï¼‰
6. æˆåŠŸè¿”å›

### åœºæ™¯3ï¼šå·²ç»‘å®šçŠ¶æ€ä¸‹æ³¨å†Œ
1. ç”¨æˆ·å·²æœ‰æœ‰æ•ˆç»‘å®šï¼ˆ`binding_status = '1'`ï¼‰
2. ç”¨æˆ·è°ƒç”¨ `/designer/user/register/designer`
3. è¿”å›"ç”¨æˆ·å·²ç»‘å®šè®¾è®¡å¸ˆèº«ä»½"é”™è¯¯
4. ä¿æŠ¤ç°æœ‰ç»‘å®šä¸è¢«æ„å¤–è¦†ç›–

## ğŸ“Š æ•°æ®æµè½¬çŠ¶æ€

### ç»‘å®šè®°å½•ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> æ— è®°å½• : åˆå§‹çŠ¶æ€
    æ— è®°å½• --> å·²ç»‘å®š : é¦–æ¬¡æ³¨å†Œ
    å·²ç»‘å®š --> å·²è§£ç»‘ : è§£ç»‘æ“ä½œ
    å·²è§£ç»‘ --> å·²ç»‘å®š : é‡æ–°æ³¨å†Œï¼ˆå¤ç”¨è®°å½•ï¼‰
    å·²ç»‘å®š --> å·²ç»‘å®š : æ›´æ–°ä¿¡æ¯
```

### æ•°æ®åº“çŠ¶æ€å˜åŒ–

| æ“ä½œ | binding_status | è®°å½•æ•°é‡ | è¯´æ˜ |
|------|----------------|----------|------|
| é¦–æ¬¡æ³¨å†Œ | '1' | 1 | åˆ›å»ºæ–°è®°å½• |
| è§£ç»‘ | '0' | 1 | è½¯åˆ é™¤ï¼Œè®°å½•ä¿ç•™ |
| é‡æ–°æ³¨å†Œ | '1' | 1 | å¤ç”¨è®°å½•ï¼Œæ›´æ–°çŠ¶æ€ |

## ğŸš€ æµ‹è¯•éªŒè¯

### 1. å®Œæ•´æµ‹è¯•æµç¨‹

```bash
# 1. é¦–æ¬¡æ³¨å†Œè®¾è®¡å¸ˆ
POST /designer/user/register/designer
{
    "designerName": "å¼ ä¸‰",
    "profession": "UI_DESIGNER",
    "email": "zhangsan@example.com",
    "phone": "13800138000",
    "skillTags": "[\"PROTOTYPE_DESIGN\", \"VISUAL_DESIGN\"]",
    "description": "ä¸“ä¸šUIè®¾è®¡å¸ˆ"
}

# 2. è§£ç»‘è®¾è®¡å¸ˆèº«ä»½
PUT /designer/user/unbind/designer

# 3. é‡æ–°æ³¨å†Œè®¾è®¡å¸ˆï¼ˆåº”è¯¥æˆåŠŸï¼‰
POST /designer/user/register/designer
{
    "designerName": "å¼ ä¸‰-æ›´æ–°",
    "profession": "INTERACTION_DESIGNER",
    "email": "zhangsan.new@example.com",
    "phone": "13800138001",
    "skillTags": "[\"INTERACTION_DESIGN\", \"USER_RESEARCH\"]",
    "description": "èµ„æ·±äº¤äº’è®¾è®¡å¸ˆ"
}
```

### 2. æ•°æ®åº“éªŒè¯

```sql
-- æŸ¥çœ‹ç»‘å®šè®°å½•çŠ¶æ€
SELECT 
    binding_id,
    user_id,
    entity_type,
    entity_id,
    binding_status,
    CASE binding_status 
        WHEN '1' THEN 'å·²ç»‘å®š'
        WHEN '0' THEN 'å·²è§£ç»‘'
    END AS status_desc,
    create_time,
    update_time
FROM des_user_binding 
WHERE user_id = {æ‚¨çš„ç”¨æˆ·ID} 
AND entity_type = 'designer'
ORDER BY update_time DESC;

-- æŸ¥çœ‹è®¾è®¡å¸ˆä¿¡æ¯å˜åŒ–
SELECT 
    designer_id,
    user_id,
    designer_name,
    profession,
    email,
    phone,
    skill_tags,
    description,
    create_time,
    update_time
FROM des_designer 
WHERE user_id = {æ‚¨çš„ç”¨æˆ·ID}
ORDER BY update_time DESC;
```

### 3. é¢„æœŸç»“æœ

#### ç»‘å®šè®°å½•
- **è®°å½•æ•°é‡**ï¼šå§‹ç»ˆåªæœ‰1æ¡è®°å½•
- **çŠ¶æ€å˜åŒ–**ï¼š'1' â†’ '0' â†’ '1'
- **æ—¶é—´æˆ³**ï¼š`update_time` åæ˜ æœ€æ–°æ“ä½œæ—¶é—´

#### è®¾è®¡å¸ˆè®°å½•
- **è®°å½•ID**ï¼šä¿æŒä¸å˜ï¼ˆå¤ç”¨ç°æœ‰è®°å½•ï¼‰
- **ä¿¡æ¯æ›´æ–°**ï¼šåæ˜ æœ€æ–°æäº¤çš„è®¾è®¡å¸ˆä¿¡æ¯
- **æ—¶é—´æˆ³**ï¼š`update_time` æ›´æ–°ä¸ºé‡æ–°æ³¨å†Œæ—¶é—´

## âœ… ä¿®å¤å®Œæˆ

ç°åœ¨ç³»ç»Ÿæ”¯æŒï¼š

1. âœ… **é¦–æ¬¡æ³¨å†Œ**ï¼šåˆ›å»ºæ–°çš„è®¾è®¡å¸ˆå’Œç»‘å®šè®°å½•
2. âœ… **æ­£å¸¸è§£ç»‘**ï¼šè½¯åˆ é™¤ç»‘å®šå…³ç³»
3. âœ… **é‡æ–°æ³¨å†Œ**ï¼šå¤ç”¨ç°æœ‰è®°å½•ï¼Œé¿å…å”¯ä¸€çº¦æŸå†²çª
4. âœ… **ä¿¡æ¯æ›´æ–°**ï¼šé‡æ–°æ³¨å†Œæ—¶æ›´æ–°è®¾è®¡å¸ˆè¯¦ç»†ä¿¡æ¯
5. âœ… **çŠ¶æ€ç®¡ç†**ï¼šæ­£ç¡®å¤„ç†ç»‘å®šçŠ¶æ€çš„è½¬æ¢

è¿™ç§è®¾è®¡æ—¢è§£å†³äº†å”¯ä¸€çº¦æŸå†²çªé—®é¢˜ï¼Œåˆä¿æŒäº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚ 